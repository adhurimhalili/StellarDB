<div>
  <span *ngIf="data != null" mat-dialog-title>Modify Star Spectral Class</span>
  <span *ngIf="data == null" mat-dialog-title>Add Star Spectral Class</span>
</div>

<!-- Form -->
<form [formGroup]="starForm" (ngSubmit)="onSubmit()">
  <mat-dialog-content class="">
    <div class="grid grid-cols-2 gap-4">
      <!-- Name -->
      <mat-form-field class="col-span-2" appearance="outline">
        <mat-label>Name</mat-label>
        <input matInput formControlName="name" maxlength="50">
      </mat-form-field>

      <!-- Spectral Class -->
      <mat-form-field appearance="outline">
        <mat-label>Spectral Class</mat-label>
        <mat-select formControlName="spectralClassId">
          <mat-option *ngFor="let spectralClass of starSpectralClasses" [value]="spectralClass.id">
            {{ spectralClass.code }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Luminosity Class -->
      <mat-form-field appearance="outline">
        <mat-label>Luminosity Class</mat-label>
        <mat-select formControlName="luminosityClassId">
          <mat-option *ngFor="let luminosityClass of starLuminosityClasses" [value]="luminosityClass.id">
            {{ luminosityClass.code }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Magnitude -->
      <mat-form-field appearance="outline">
        <mat-label>Magnitude</mat-label>
        <input matInput formControlName="magnitude" type="number" step="any">
      </mat-form-field>

      <!-- Diameter -->
      <mat-form-field appearance="outline">
        <mat-label>Diameter (km)</mat-label>
        <input matInput formControlName="diameter" type="number" step="any">
      </mat-form-field>

      <!-- Distance -->
      <mat-form-field appearance="outline">
        <mat-label>Distance (ly)</mat-label>
        <input matInput formControlName="distance" type="number" step="any">
      </mat-form-field>

      <!-- Mass -->
      <mat-form-field appearance="outline">
        <mat-label>Mass (Mâ˜‰)</mat-label>
        <input matInput formControlName="mass" type="number" step="any">
      </mat-form-field>

      <!-- Temperature -->
      <mat-form-field appearance="outline">
        <mat-label>Temperature (K)</mat-label>
        <input matInput formControlName="temperature" type="number" step="any">
      </mat-form-field>

      <!-- Discovery Date -->
      <mat-form-field appearance="outline">
        <mat-label>Discovery Date</mat-label>
        <input matInput formControlName="discoveryDate" type="date">
      </mat-form-field>

      <!-- Description -->
      <mat-form-field class="col-span-2" appearance="outline">
        <mat-label>Description</mat-label>
        <textarea matInput formControlName="description" rows="3"></textarea>
      </mat-form-field>

      <!-- Composition Accordion -->
      <mat-accordion class="col-span-2 mb-2">

        <!-- Chemical Elements -->
        <mat-expansion-panel hideToggle>
          <mat-expansion-panel-header>
            <mat-panel-title> Geological Composition </mat-panel-title>

            <!-- Total Percentage -->
            <mat-panel-description class="text-sm">
              <span [ngClass]="{'text-red-500': getTotalPercentage('composition') > 100}">Total: {{getTotalPercentage('composition')}}%</span>
            </mat-panel-description>

          </mat-expansion-panel-header>
          <div formArrayName="composition">
            <div class="grid grid-cols-[200px_auto_12%_50px] gap-4" *ngFor="let group of compositionArray.controls; let i = index" [formGroupName]="i">

              <!-- Element Dropdown -->
              <div>
                <mat-form-field appearance="outline">
                  <mat-label>Element</mat-label>
                  <mat-select formControlName="id">
                    <mat-option *ngFor="let element of chemicalElements" [value]="element.id">
                      {{element.name}}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </div>

              <!-- Percentage Slider -->
              <div class="w-auto">
                <mat-slider step="0.01" min="0"
                            [max]="getRemainingPercentage('composition') + group.get('percentage')?.value">
                  <input matSliderThumb formControlName="percentage" value="{{ group.get('percentage')?.value }}" />
                </mat-slider>
              </div>

              <!-- Percentage Input -->
              <mat-form-field class="" appearance="outline">
                <input matInput type="number" formControlName="percentage" step="0.01" min="0"
                       [max]="getRemainingPercentage('composition') + group.get('percentage')?.value"
                       value="{{ group.get('percentage')?.value }}">
                <span matTextSuffix>%</span>
                <mat-error *ngIf="compositionArray.hasError('totalExceeded')">
                  Total percentage cannot exceed 100%
                </mat-error>
              </mat-form-field>

              <!-- Delete Button -->
              <div>
                <button matIconButton type="button" (click)="removeComposition(i)">
                  <span class="text-red-500"><mat-icon class="text-red-500">delete</mat-icon></span>
                </button>
              </div>
            </div>
          </div>

          <!-- Remaining percentage row (readonly) -->
          <div class="grid grid-cols-[200px_auto_12%_50px] gap-4">
            <div>
              <mat-form-field appearance="outline" class="w-full">
                <input matInput readonly value="Other">
              </mat-form-field>
            </div>
            <div class="w-auto">
              <mat-slider min="0" max="100" step="0.01" [disabled]="true">
                <input matSliderThumb [value]="100 - getTotalPercentage('composition')" />
              </mat-slider>
            </div>
            <mat-form-field class="" appearance="outline">
              <input matInput type="number" readonly [value]="100 - getTotalPercentage('composition')">
              <span matTextSuffix>%</span>
            </mat-form-field>
            <div></div>
          </div>

          <!-- Add -->
          <button mat-button type="button" (click)="addComposition()">Add Composition Element</button>
        </mat-expansion-panel>

      </mat-accordion>

    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="center">
    <!-- Submit Button -->
    <div class="flex justify-center">
      <button color="primary" mat-button type="submit">Save</button>
    </div>
  </mat-dialog-actions>
</form>
